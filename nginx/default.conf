server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ✅ força charset para HTML/CSS/JS e evita “SeridÃ³Hub”
  charset utf-8;

  # ✅ logs úteis (opcional, mas ajuda muito)
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  # =========================
  # Estáticos (cache + segurança)
  # =========================

  # Tipos básicos (geralmente já vem no nginx.conf global, mas aqui garante)
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # Cache forte para assets versionados (se você usar ?v=)
  location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf)$ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # Pastas estáticas principais
  location /assets/   { try_files $uri =404; }
  location /css/      { try_files $uri =404; }
  location /js/       { try_files $uri =404; }
  location /partials/ { try_files $uri =404; }

  # =========================
  # API (proxy com timeouts)
  # =========================
  location /api/ {
    proxy_pass http://backend:3000;
    proxy_http_version 1.1;

    # headers corretos
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # ✅ timeouts para evitar “carregando infinito”
    proxy_connect_timeout 5s;
    proxy_send_timeout    30s;
    proxy_read_timeout    30s;
    send_timeout          30s;

    # ✅ evita algumas tretas com respostas em streaming
    proxy_buffering on;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;

    # CORS (opcional, se precisar)
    # add_header Access-Control-Allow-Origin "*" always;
    # add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    # add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    # if ($request_method = OPTIONS) { return 204; }
  }

  # =========================
  # SPA / páginas
  # =========================
  location / {
    # ✅ se pedir /meus_produtos.html ele acha
    # ✅ se pedir /meus_produtos (sem .html) ele NÃO vai achar (normal)
    try_files $uri $uri/ =404;
  }
}
